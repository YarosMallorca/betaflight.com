"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3046],{35485:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>c,frontMatter:()=>l,metadata:()=>r,toc:()=>d});var i=t(85893),s=t(11151);const l={},o="SITL",r={id:"development/SITL",title:"SITL",description:"SITL in Gazebo",source:"@site/docs/development/SITL.mdx",sourceDirName:"development",slug:"/development/SITL",permalink:"/docs/development/SITL",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"development",previous:{title:"Receivers (RX)",permalink:"/docs/development/Rx"},next:{title:"Safety",permalink:"/docs/development/Safety"}},a={},d=[{value:"SITL in Gazebo",id:"sitl-in-gazebo",level:2},{value:"Install Gazebo",id:"install-gazebo",level:3},{value:"Build Betaflight",id:"build-betaflight",level:3},{value:"Settings",id:"settings",level:3},{value:"Start and Run",id:"start-and-run",level:3},{value:"SITL in RealFlight 9",id:"sitl-in-realflight-9",level:2},{value:"Setup",id:"setup",level:3},{value:"SITL",id:"sitl-1",level:3},{value:"Customize",id:"customize",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"sitl",children:"SITL"}),"\n",(0,i.jsx)(n.h2,{id:"sitl-in-gazebo",children:"SITL in Gazebo"}),"\n",(0,i.jsx)(n.p,{children:"SITL (software in the loop) simulator allows you to run Betaflight without any hardware."}),"\n",(0,i.jsx)(n.h3,{id:"install-gazebo",children:"Install Gazebo"}),"\n",(0,i.jsxs)(n.p,{children:["Official ",(0,i.jsx)(n.a,{href:"https://gazebosim.org/docs",children:"Installation"})]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://ubuntu.com/blog/install-gazebo-for-ros-2-in-under-a-minute",children:"https://ubuntu.com/blog/install-gazebo-for-ros-2-in-under-a-minute"})})}),"\n",(0,i.jsxs)(n.p,{children:["Please also check ",(0,i.jsx)(n.a,{href:"https://github.com/osrf/vehicle_gateway",children:"Vehicle Gateway"})]}),"\n",(0,i.jsx)(n.h3,{id:"build-betaflight",children:"Build Betaflight"}),"\n",(0,i.jsxs)(n.p,{children:["Run ",(0,i.jsx)(n.code,{children:"make TARGET=SITL"})]}),"\n",(0,i.jsx)(n.h3,{id:"settings",children:"Settings"}),"\n",(0,i.jsx)(n.p,{children:"To avoid the simulation speed slowing down, it is suggested to set some settings, shown below:"}),"\n",(0,i.jsxs)(n.p,{children:["In ",(0,i.jsx)(n.code,{children:"configuration"})," page:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ESC/Motor"}),": ",(0,i.jsx)(n.code,{children:"PWM"}),", disable ",(0,i.jsx)(n.code,{children:"Motor PWM speed Sparted from PID speed"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PID loop frequency"})," as high as it can."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"start-and-run",children:"Start and Run"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Start Betaflight: ",(0,i.jsx)(n.code,{children:"./obj/main/betaflight_SITL.elf"})]}),"\n",(0,i.jsxs)(n.li,{children:["Start Gazebo: ",(0,i.jsx)(n.code,{children:"gazebo --verbose ./iris_arducopter_demo.world"})]}),"\n",(0,i.jsxs)(n.li,{children:["Connect your transmitter and fly/test, used app to send ",(0,i.jsx)(n.code,{children:"MSP_SET_RAW_RC"}),", see ",(0,i.jsx)(n.a,{href:"https://github.com/cs8425/msp-controller",children:"code"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.p,{children:["Betaflight -> Gazebo ",(0,i.jsx)(n.code,{children:"udp://127.0.0.1:9002"}),"\nGazebo -> Betaflight ",(0,i.jsx)(n.code,{children:"udp://127.0.0.1:9003"})]}),(0,i.jsxs)(n.p,{children:["UARTx will bind on ",(0,i.jsx)(n.code,{children:"tcp://127.0.0.1:576x"})," when the port has been opened."]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"eeprom.bin"}),", size 8192 Byte, is for config saving.\nSize can be changed in ",(0,i.jsx)(n.code,{children:"src/main/target/SITL/pg.ld"})," >> ",(0,i.jsx)(n.code,{children:"__FLASH_CONFIG_Size"})]})]}),"\n",(0,i.jsx)(n.h2,{id:"sitl-in-realflight-9",children:"SITL in RealFlight 9"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://www.realflight.com/",children:"RealFlight"})," is one of the best commercial RC simulators with accurate airplane, helicopter, and multirotor simulations.\nArduPilot also offers ",(0,i.jsx)(n.a,{href:"https://ardupilot.org/dev/docs/sitl-with-realflight.html",children:"RealFlight SITL"}),".\nTo use it you may need to purchase it on ",(0,i.jsx)(n.a,{href:"https://store.steampowered.com/app/1070820/RealFlight_95S/",children:"Steam"})," or ",(0,i.jsx)(n.a,{href:"https://www.realflight.com/",children:"offical website"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,i.jsxs)(n.p,{children:["To let Betaflight SITL work with RealFlight, you need Windows 10 or Windows 11 with WSL.\nUbuntu 20.04 in WSL2 on Windows 11 x64 is tested.\n",(0,i.jsx)(n.a,{href:"https://github.com/xuhao1/RealFlightBridge",children:"RealFlightBridge"})," is also required."]}),"\n",(0,i.jsxs)(n.p,{children:["On WSL2, you need to configure the Betaflight following ",(0,i.jsx)(n.a,{href:"/docs/development/Building-in-Windows",children:"document here"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Build Betaflight with"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ make TARGET=SITL\n"})}),"\n",(0,i.jsx)(n.p,{children:"On Windows, download RealFlightBridge by"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ git clone https://github.com/xuhao1/RealFlightBridge.git\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Import the quadcopter for RealFlight and Betaflight at ",(0,i.jsx)(n.strong,{children:"models/Quadcopter X Betaflight - flightaxis_AV.RFX"})," in RealFlightBridge. A detailed guide for improtanting can be found ",(0,i.jsx)(n.a,{href:"https://ardupilot.org/dev/docs/sitl-with-realflight.html",children:"here"}),".\nMoreover, update the setting of RealFlight to allow API.\n",(0,i.jsx)(n.img,{src:t(2645).Z+"",width:"712",height:"482"})]}),"\n",(0,i.jsxs)(n.p,{children:["You also need to prepare a controller for running SITL.\nWe recommend to use transmitter with OpenTX/EdgeTX as a game controller. In addition, mixers of channel 5 and 6 should be mapped to two switches for arming and changing mode.\n",(0,i.jsx)(n.img,{src:t(82809).Z+"",width:"1702",height:"1276"})]}),"\n",(0,i.jsx)(n.h3,{id:"sitl-1",children:"SITL"}),"\n",(0,i.jsx)(n.p,{children:"To running SITL, you may need to:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open and select the newly improted model ",(0,i.jsx)(n.strong,{children:"Quadcopter X Betaflight - flightaxis"})," in RealFlight.\n",(0,i.jsx)(n.img,{src:t(89889).Z+"",width:"883",height:"589"})]}),"\n",(0,i.jsxs)(n.p,{children:["You need to restart RealFlight after you ",(0,i.jsx)(n.em,{children:"edit"})," the model in RealFlight!"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Starting the RealFlightBridge in ",(0,i.jsx)(n.strong,{children:"Windows"})," by"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ python betaflight_bridge.py\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You must start RealFlightBridge in Windows ",(0,i.jsx)(n.strong,{children:"before"})," start the Betaflight SITL."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Start the Betaflight SITL.\nFirst you need to get the Windows' IP in WSL.\nIn WSL enter"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ (ipconfig.exe | grep 'vEthernet (WSL)' -A4 | cut -d\":\" -f 2 | tail -n1 | sed -e 's/\\s*//g')\n172.19.32.1\n$ ifconfig\neth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n    inet 172.19.41.192 netmask 255.255.240.0  broadcast 172.19.47.255\n    inet6 fe80::215:5dff:fea4:215d  prefixlen 64  scopeid 0x20<link>\n    ether 00:15:5d:a4:21:5d  txqueuelen 1000  (Ethernet)\n    RX packets 219079  bytes 32440158 (32.4 MB)\n    RX errors 0  dropped 0  overruns 0  frame 0\n    TX packets 145744  bytes 10533796 (10.5 MB)\n    TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n"})}),"\n",(0,i.jsxs)(n.p,{children:["172.19.32.1 is the example output of your Windows IP and 172.19.41.192 is your WSL IP. ",(0,i.jsx)(n.strong,{children:"These IPs change everytime you reboot the computer."})]}),"\n",(0,i.jsx)(n.p,{children:"Then go to the Betaflight root and start the SITL with this IP."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ cd ~/develop/betaflight/\n$ ./obj/main/betaflight_SITL.elf 172.19.32.1\nThe SITL will output to IP 172.19.32.1:9002 (Gazebo) and 172.19.32.1:9001 (RealFlightBridge)\n[system]Init...\ninit PwmOut UDP link to gazebo 172.19.32.1:9002...0\ninit PwmOut UDP link to RF9 172.19.32.1:9001...0\nstart UDP server @9003...0\nstart UDP server for RC input @9004...0\n[FLASH_Unlock] loaded 'eeprom.bin', size = 32768 / 32768\n[timer]Init...\n[data]new fdm 136 t:182.834571 from 0.0.0.0:0\n[data]new rc 40: t:182.834571 AETR: 1498 1501 1105 1501 AUX1-4: 1100 1899 1899 1100\nbind port 5761 for UART1\nunusedPinsInit\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then you can open the Betaflight Configurator on ",(0,i.jsx)(n.strong,{children:"Windows"})," to connect to RealFlight via ",(0,i.jsx)(n.strong,{children:"WSL IP"}),".\n",(0,i.jsx)(n.img,{src:t(16328).Z+"",width:"674",height:"148"})]}),"\n",(0,i.jsxs)(n.p,{children:["After connect to Betaflight you need to apply this ",(0,i.jsx)(n.a,{target:"_blank",href:t(15452).Z+"",children:"DIFF file"})," and set the arming switch with your controller."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Finally, you can arm and take-off the Quadcopter with Betaflight SITL in RealFlight with your controller."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(61764).Z+"",width:"3440",height:"1395"})}),"\n",(0,i.jsx)(n.h2,{id:"customize",children:"Customize"}),"\n",(0,i.jsxs)(n.p,{children:["If you want to create your own model and extend the SITL, please refer to this ",(0,i.jsx)(n.a,{href:"http://www.knifeedge.com/KEmax/",children:"guide"})," and this ",(0,i.jsx)(n.a,{href:"https://github.com/xuhao1/RealFlightBridge/blob/main/docs/realflight_protocol.md",children:"document"}),"."]})]})}function c(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},15452:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/files/BTFL_quadcopter_rf9-1387c7b741d0c09e3aa5204064898767.txt"},61764:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/SITL_RF-4364d10f9c54b234d66517fd5441536a.jpg"},16328:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/betaflight-4975866f45fcaf9ca5688965afc778b4.jpg"},2645:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/rf_settings-290f49efdc6d05da222434671af50d71.jpg"},89889:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/select-588af10f5f351e4fabb53328c78b6e58.jpg"},82809:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/transmitter-642cf7c6dd9b326729a39ea5d6ae0efb.jpg"},11151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>o});var i=t(67294);const s={},l=i.createContext(s);function o(e){const n=i.useContext(l);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);