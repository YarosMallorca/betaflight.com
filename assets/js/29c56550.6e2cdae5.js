"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6671],{50839:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>r,metadata:()=>h,toc:()=>d});var i=n(85893),a=n(11151);const o=n.p+"assets/images/MagOrientationDiagram-d516836ac044366916bb637c1a7807a8.png",r={},s="Magnetometer / Compass",h={id:"wiki/guides/current/Magnetometer",title:"Magnetometer / Compass",description:"These notes only apply to Magnetometers in Betaflight 4.5 or higher",source:"@site/docs/wiki/guides/current/Magnetometer.md",sourceDirName:"wiki/guides/current",slug:"/wiki/guides/current/Magnetometer",permalink:"/docs/wiki/guides/current/Magnetometer",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"wiki",previous:{title:"Launch Control",permalink:"/docs/wiki/guides/current/Launch-Control"},next:{title:"Mass Storage Device Support",permalink:"/docs/wiki/guides/current/Mass-Storage-Device-(MSC)-Support"}},l={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Summary",id:"summary",level:2},{value:"What is a Magnetometer?",id:"magnetometer-explanation",level:2},{value:"About the Earth&#39;s Magnetic Field",id:"about-the-earths-magnetic-field",level:2},{value:"Setting local declination in the CLI",id:"setting-local-declination-in-the-cli",level:2},{value:"Hardware and Connection",id:"hardware-and-connection",level:2},{value:"Magnetometer Mounting and Orientation",id:"magnetometer-mounting-and-orientation",level:2},{value:"Checking Magnetometer Orientation using Configurator&#39;s Sensors Tab",id:"checking-magnetometer-orientation-using-configurators-sensors-tab",level:3},{value:"Software Corrections for Unusual Magnetometer Orientations",id:"software-corrections-for-unusual-magnetometer-orientations",level:3},{value:"Magnetometer Calibration",id:"magnetometer-calibration",level:2},{value:"Calibration Initiation",id:"calibration-initiation",level:3},{value:"Calibration Technique",id:"calibration-technique",level:3},{value:"Single-axis calibration",id:"single-axis-calibration",level:3},{value:"Validating the Heading using a mobile phone.",id:"validating-the-heading-using-a-mobile-phone",level:3},{value:"Fine-tuning Calibration in Sensors Tab.",id:"fine-tuning-calibration-in-sensors-tab",level:3},{value:"Where is heading information displayed?",id:"where-is-heading-information-displayed",level:2},{value:"External Links",id:"external-links",level:2}];function c(e){const t={a:"a",admonition:"admonition",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",section:"section",strong:"strong",sup:"sup",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h1,{id:"magnetometer--compass",children:"Magnetometer / Compass"}),"\n",(0,i.jsxs)(t.admonition,{type:"warning",children:[(0,i.jsx)(t.p,{children:"These notes only apply to Magnetometers in Betaflight 4.5 or higher"}),(0,i.jsxs)(t.p,{children:["Do ",(0,i.jsx)(t.strong,{children:"NOT"})," use a magnetometer unless you have confirmed that:"]}),(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"the magnetometer's axes are correctly oriented"}),"\n",(0,i.jsx)(t.li,{children:"the calibration is accurate"}),"\n",(0,i.jsx)(t.li,{children:"the returned values are clean and noise-free"}),"\n",(0,i.jsx)(t.li,{children:"the correct local declination angle is entered in the CLI"}),"\n",(0,i.jsx)(t.li,{children:"the heading returned by the mag is correct"}),"\n",(0,i.jsx)(t.li,{children:"Acc is enabled, correctly oriented, and calibrated"}),"\n",(0,i.jsx)(t.li,{children:"GPS is included in the firmware, and enabled, to see the heading data"}),"\n"]})]}),"\n",(0,i.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(t.p,{children:"The purpose of a magnetometer is to return the 'heading' of the quad, meaning the direction the nose of the quad is pointing in. More precisely, we want the angle in degrees between the nose of the quad and \"true North\". When set up correctly, the returned value should, for example, be 90 degrees when the nose of the quad is pointing due East, 180 degrees when pointing due South, etc."}),"\n",(0,i.jsx)(t.p,{children:"Mag information is essential for position hold, which we intend to support, and improves behaviour in GPS Rescue."}),"\n",(0,i.jsx)(t.p,{children:"GPS Rescue will have improved eading control if reliable, accurate Mag information is available, especially during ascents and descents on windy days."}),"\n",(0,i.jsx)(t.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["please read ",(0,i.jsx)(t.em,{children:"all"})," of this document before using a magnetometer (3D compass)"]}),"\n",(0,i.jsx)(t.li,{children:"the firmware must be custom built to include Mag support"}),"\n",(0,i.jsx)(t.li,{children:"the magnetometer must power up at the same time as the flight controller"}),"\n",(0,i.jsxs)(t.li,{children:["the CLI ",(0,i.jsx)(t.code,{children:"status"})," command must show the correct hardware as being connected"]}),"\n",(0,i.jsx)(t.li,{children:"the magnetometer must be oriented correctly, and the orientation must be checked"}),"\n",(0,i.jsx)(t.li,{children:"the magnetometer must be calibrated accurately"}),"\n",(0,i.jsx)(t.li,{children:"the user must set the local declination angle in the CLI"}),"\n",(0,i.jsx)(t.li,{children:"the user must confirm that the reported heading is correct while in flight, from mag alone"}),"\n",(0,i.jsx)(t.li,{children:"the user must get GPS Rescue working properly, without Mag, before enabling the Mag"}),"\n",(0,i.jsx)(t.li,{children:"the user must make careful tests of GPS Rescue when adding Mag. With Mag, the initial rotation/climb phase, and the descent phase, should show more accurate heading control, especially in windy conditions. If it makes no difference to the rescue, or causes problems, don't use it."}),"\n"]}),"\n",(0,i.jsx)(t.admonition,{type:"danger",children:(0,i.jsx)(t.p,{children:"DO NOT enable Mag if you rely on GPS rescue, until you are ABSOLUTELY CERTAIN that the Mag data is accurate and reliable!"})}),"\n",(0,i.jsx)(t.h2,{id:"magnetometer-explanation",children:"What is a Magnetometer?"}),"\n",(0,i.jsxs)(t.p,{children:["A magnetometer is a three-axis device that detects the local strength and direction of the ",(0,i.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Earth%27s_magnetic_field",children:"earth's magnetic field"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-1",id:"user-content-fnref-1","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})}),"."]}),"\n",(0,i.jsx)(t.p,{children:"Magnetometer sensors output data on three mutually perpendicular axes: X, Y and Z. The relative relationship between the three axes is typically as follows: if Z is up, and X is forward, Y points left. This is true for the popular QMC5883L. However, some magnetometers orient the axes differently."}),"\n",(0,i.jsx)(t.p,{children:"For most Mag modules, if the magnetometer has arrows indicating the direction of the X and Y axes on the board, the direction of the Z axis most likely will be:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"upwards, if the Y axis is 90\xb0 to the left of X axis, or"}),"\n",(0,i.jsx)(t.li,{children:"downwards, if the Y axis is 90\xb0 to the right of the X axis"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"When one of the Mag sensor's three axes points directly parallel to a magnetic field line, that axis returns its most positive value, and the other two axes return zero. Conversely, when pointing into the opposite direction, the axis returns its most negative value, and the other two axes return zero. This is how the user can determine the orietnation of the axes in their module."}),"\n",(0,i.jsxs)(t.admonition,{type:"caution",children:[(0,i.jsx)(t.p,{children:"The orientation of the magnetometer on the quad is very important. In Betaflight, the data from the magnetometer must be returned as follows:"}),(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["X must point ",(0,i.jsx)(t.strong,{children:"forward"})]}),"\n",(0,i.jsxs)(t.li,{children:["Y must point ",(0,i.jsx)(t.strong,{children:"left"})]}),"\n",(0,i.jsxs)(t.li,{children:["Z must point ",(0,i.jsx)(t.strong,{children:"up"})]}),"\n"]}),(0,i.jsx)(t.p,{children:"Always use the Sensors tab to confirm that the sensor orientation is correct. If the Mag is an IST8310, its non-compliant Y axis orientation must be corrected with a custom configuration that rotates the Y axis by 180 degrees."})]}),"\n",(0,i.jsxs)("figure",{className:"align-center",children:[(0,i.jsx)("img",{src:o,alt:"Figure of magnetometer axes and orientation",className:"no-effect "}),(0,i.jsx)("figcaption",{children:(0,i.jsxs)(t.p,{children:[(0,i.jsx)("b",{children:"Fig. 1"})," - Magnetometer axes and orientation in relation to the drone as expected by Betaflight"]})}),(0,i.jsx)("br",{})]}),"\n",(0,i.jsx)(t.p,{children:"In most standalone modules, such as the GY-271 board, the sensor is soldered on the top of the board, and typically the Z axis points upwards. In most GPS modules, the sensor is mounted upside-down, and the Z axis points downwards. The sensor can be soldered with it's X axis faces forward, or 180 degrees backwards, or left, or right. Hence the orientation of the axes varies greatly from module to module."}),"\n",(0,i.jsx)(t.p,{children:"The orientation of the axis also varies according to the orientation of the module when it is attached to the quadcopter."}),"\n",(0,i.jsxs)(t.p,{children:["If the magnetometer cannot be physically positioned so that its axes are aligned as per the diagram above, the ",(0,i.jsx)(t.code,{children:"Mag alignment"})," setting in Configurator (",(0,i.jsx)(t.code,{children:"align_mag"})," in the ",(0,i.jsx)(t.a,{href:"../configurator/cli-tab",children:"CLI"}),") may be used to correct for other mag orientations. Standard corrections (e.g. ",(0,i.jsx)(t.code,{children:"CW90"})," to rotate the axes 90 degrees clockwise) are provided for common alignment problems. If the module is tilted backwards, or at an unusual angle, a ",(0,i.jsx)(t.code,{children:"custom"})," orientation correction will be required."]}),"\n",(0,i.jsx)(t.p,{children:"The correct orientation of a given axis should be confirmed by checking the Magnetometer data in the Sensors tab."}),"\n",(0,i.jsx)(t.h2,{id:"about-the-earths-magnetic-field",children:"About the Earth's Magnetic Field"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Earth%27s_magnetic_field",children:"The earth's magnetic field"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-1",id:"user-content-fnref-1-2","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})})," is not uniform. Its field lines usually point a few degrees away from geographic North and either down (in the Northern Hemisphere) or up (in the Southern Hemisphere). Both the field direction and strength vary from place to place."]}),"\n",(0,i.jsxs)(t.p,{children:["The earth's magnetic field is usually represented in a ",(0,i.jsx)(t.strong,{children:"NED"})," (north-east-down) frame of reference. This means that the X axis of the earth's field points North, the Y axis points East, and the Z axis points Down. This representation is not at all relevant for Betaflight's mag orientation, but may be useful when interpreting the magnetic field strength and direction values reported for your location."]}),"\n",(0,i.jsx)(t.p,{children:"The absolute strength of the field is measured in Gauss, or milliTeslas, where 1.0 Gauss = 0.1 milliTesla. In my location, the field strength is approximately 0.57 Gauss. Betaflight's sensors tab shows the values reported by the sensor, and these depend on the sensor gain, which can be found in the specification sheet. For example, the QMC5883L returns a value of 3000 for a field strength of 1 Gauss, so that in Sydney I would expect to get a value 1710 when that sensor, after calibration, was aligned directly into the field."}),"\n",(0,i.jsx)(t.p,{children:"When we measure the magnetic field at a particular point on earth, we are measuring a local field vector which usually points a few degrees away from geographic North, and either down into the ground in the Northern Hemisphere, or up out of the ground in the Southern Hemisphere. There are considerable angular deviations, especially in the up or down angle, depending upon where you are on the surface of the Earth."}),"\n",(0,i.jsxs)(t.p,{children:["The sideways deviation of the Earth's magnetic field from the geographic north is called the ",(0,i.jsx)(t.strong,{children:"magnetic declination"}),". It is measured in degrees, with positive values meaning that the magnetic North is to the East of the geographic North."]}),"\n",(0,i.jsxs)(t.p,{children:["The angle at which the field points into (or out of) the Earth's surface is called the ",(0,i.jsx)(t.strong,{children:"magnetic inclination"}),", or ",(0,i.jsx)(t.strong,{children:"magnetic dip"}),". See ",(0,i.jsx)(t.a,{href:"https://physicsmax.com/inclination-dip-7371",children:"physicsmax.com"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-2",id:"user-content-fnref-2","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"2"})})," for a nice explanation and graphic. Inclination is measured in degrees 'into' the ground. In the Northern Hemisphere the Earth's magnetic field points down into the ground (positive inclination values), and in the Southern Hemisphere it points up into the sky (negative inclination values)."]}),"\n",(0,i.jsxs)(t.p,{children:["Local declination and inclination values are available from online sources such as ",(0,i.jsx)(t.a,{href:"https://www.ngdc.noaa.gov/geomag/calculators/magcalc.shtml",children:"NOAA"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-3",id:"user-content-fnref-3","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"3"})}),", or via clickable map at sites like ",(0,i.jsx)(t.a,{href:"https://www.magnetic-declination.com",children:"magnetic-declination.com"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-4",id:"user-content-fnref-4","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"4"})}),"."]}),"\n",(0,i.jsx)(t.p,{children:"As an example, in Sydney, Australia, 34 degrees South and 151 degrees East, the Earth's magnetic field is 13 degrees east of the geographic North, and points out of the ground, steeply upwards, at 65 degrees. With a properly calibrated and correctly oriented Mag, a maximallly positive value on the Mag X axis should be seen in the Sensors tab, and close to zero on the Y and Z axes, when the nose of my quad is pointed 13 degrees East of North, and 65 degrees up."}),"\n",(0,i.jsx)(t.h2,{id:"setting-local-declination-in-the-cli",children:"Setting local declination in the CLI"}),"\n",(0,i.jsxs)(t.p,{children:["In Betaflight 4.5, the CLI variable ",(0,i.jsx)(t.code,{children:"mag_declination"}),' was introduced, to correct for declination offsets. When correctly set, Betaflight will return "true North", not "magnetic North", and will match the GPS course over ground values, which are returned relative to true North. Declination values should be entered in decidegrees; in the above example, ',(0,i.jsx)(t.code,{children:"set mag_declination = 130"})," would correct for a 13 degree positive declination. A negative local declination, eg -3 degrees, should be entered as ",(0,i.jsx)(t.code,{children:"set mag_declination = 3570"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"hardware-and-connection",children:"Hardware and Connection"}),"\n",(0,i.jsxs)(t.p,{children:["Betaflight's build system must include ",(0,i.jsx)(t.code,{children:"Magnetometers"}),", from the dropdown in the cloud build, or ",(0,i.jsx)(t.code,{children:"-DUSE_MAG"})," for local builds, otherwise there will be no Mag support in the firmware. Additionally, GPS firmware should be included in the build, because we display the Mag heading on Configurator's GPS tab, and use GPS debugs to display the Mag heading information."]}),"\n",(0,i.jsx)(t.p,{children:"Betaflight provides drivers for the following magnetometers, but not all have been validated to work with Betaflight 4.5 at the time of writing:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"https://datasheet.lcsc.com/szlcsc/QST-QMC5883L-TR_C192585.pdf",children:"QMC5883L"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-8",id:"user-content-fnref-8","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"5"})}),". The QMC5883L is provided on the common, and cheap, GY-217 module, and many GPS units. It provides a 200Hz data update rate, 8x sample averaging and 3000 LSB/Gauss sensitivity. Standard axis orientation. We recommend using this mag if it is an option for your build, because it's performance has been validated during testing - we know it works well."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"https://intofpv.com/attachment.php?aid=8104",children:"IST8310"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-9",id:"user-content-fnref-9","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"6"})})," Note that this gyro has a highly unusual axis orientation, with Y to the ",(0,i.jsx)(t.em,{children:"right"})," when X is forward and Z is up, and will ",(0,i.jsx)(t.em,{children:"always"})," require a custom axis orientation in the CLI. Data update rate is 160Hz with 16x sample averaging and 330 LSB/Gauss sensitivity."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"https://www.st.com/resource/en/datasheet/lis3mdl.pdf",children:"STM's LIS3MDL"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-10",id:"user-content-fnref-10","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"7"})})," This mag is integral to a combined Gyro, Acc and Mag '9 axis' chip from STM. Standard axis orientation."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"https://cdn-shop.adafruit.com/datasheets/HMC5883L_3-Axis_Digital_Compass_IC.pdf",children:"HMC5883L"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-7",id:"user-content-fnref-7","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"8"})})," ODR is 75Hz with 1090 LSB/Gauss sensitivity; discontinued and replaced by the QMC6883L. Standard axis orientation. Validated."]}),"\n",(0,i.jsxs)(t.li,{children:["Deprecated: ",(0,i.jsx)(t.a,{href:"https://www.alldatasheet.com/datasheet-pdf/pdf/535561/AKM/AK8963.html",children:"AK8963"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-5",id:"user-content-fnref-5","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"9"})})," and ",(0,i.jsx)(t.a,{href:"https://www.alldatasheet.com/datasheet-pdf/pdf/535562/AKM/AK8975.html",children:"AK8975"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-6",id:"user-content-fnref-6","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"10"})}),", (both discontinued; some versions have Z up, others down, all return standard axis orientation when mounted with X forward)."]}),"\n"]}),"\n",(0,i.jsx)(t.admonition,{type:"caution",children:(0,i.jsx)(t.p,{children:"The AK8963 and AK8975 driver code is deprecated in Betaflight 4.5, and will be removed at some point. These Mags, or may not, work with Betaflight 4.5. No developers have these units, so we can't test them. Please take particular care when using 4.5 with these Mag units. Confirm that the Mag task does not cause issues with other i2c devices, and that the data from these units is usable. We strongly recommend using a current Mag like the QMC5883L."})}),"\n",(0,i.jsxs)(t.p,{children:["The user can use",(0,i.jsx)(t.code,{children:"set mag_hardware = AUTO"})," in CLI, which is the default, and Betaflight will automatically identify a connected and supported Mag."]}),"\n",(0,i.jsx)(t.admonition,{type:"warning",children:(0,i.jsx)(t.p,{children:"Magnetometer detection takes place on power up. Make sure that the Mag powers up at the same time as the FC."})}),"\n",(0,i.jsx)(t.p,{children:"The magnetometer is usually connected via i2C. Wire up the SCL and SDA pins on the module to the pins of the same name on the FC, and power the module with either 5V or 3.3V depending its requirements."}),"\n",(0,i.jsx)(t.p,{children:"When connected by i2C, the following CLI settings are needed:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"set mag_bustype = I2C"})}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"set mag_i2c_address = 0"})," (automatically determine from the connected Mag)"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"set mag_i2c_device = 1"})," (always 1, not sure why)"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"When the firmware is built with Mag support, the Accelerometer enabled, and a supported Magnetometer is wired up properly, Mag can be enabled in the Configurator's System Configuration tab, and saved. From that point:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"the Mag hardware icon at the top (N with triangle above it) will illuminate"}),"\n",(0,i.jsx)(t.li,{children:"Mag Alignment settings are available in the top right of the Configuration tab in Configurator"}),"\n",(0,i.jsx)(t.li,{children:"in the Sensors tab, enabling Magnetometer at the top will display the current X, Y and Z magnetometer values"}),"\n",(0,i.jsxs)(t.li,{children:["the ",(0,i.jsx)(t.code,{children:"status"})," command in CLI will show the detected Mag hardware"]}),"\n"]}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsx)(t.p,{children:"The Accelerometer must always be enabled when using a Mag, to correct the heading estimate for pitch or roll variations!"})}),"\n",(0,i.jsx)(t.h2,{id:"magnetometer-mounting-and-orientation",children:"Magnetometer Mounting and Orientation"}),"\n",(0,i.jsxs)(t.p,{children:["As noted previously, Betaflight expects that, with respect to ",(0,i.jsx)(t.em,{children:"both"})," the Accelerometer, and the frame of the quad, the magnetic field information matches the following requirements:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"X axis functionally points forward,"}),"\n",(0,i.jsx)(t.li,{children:"Y axis functionally points left, and"}),"\n",(0,i.jsx)(t.li,{children:"Z axis functionally points up."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"If this is not the case, the Mag data will be useless, and could cause a GPS rescue to fail. Software adjustments may be required to get the 'orientation-corrected' Mag axes and 'orientation-corrected' Accelerometer axes to match the orientation of the frame."}),"\n",(0,i.jsx)(t.p,{children:"A stand-alone external Mag module that can be mounted anywhere on the quad, eg a GY-271, is best mounted:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"centrally"}),"\n",(0,i.jsx)(t.li,{children:"in the same plane of the FC, usually meaning both are 'flat to the quad'"}),"\n",(0,i.jsx)(t.li,{children:"as far as possible, away from motors and other metallic onjects, or high-current wires"}),"\n",(0,i.jsx)(t.li,{children:"with the X axis pointing forward, directly to the nose of the quad, Y left and Z up"}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["If the Mag is part of your GPS module, the above requirements also apply. It's definitely easier if the GPS is flat to the quad, otherwise you'll need to figure how to enter the correct custom alignment settings. Also note that the Mag sensor may be inverted, or in an unknown orientation, as explained ",(0,i.jsx)(t.a,{href:"#magnetometer-explanation",children:"above"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"No matter how it is mounted, is absolutely essential to confirm proper orientation of the Mag before using it!"}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsx)(t.p,{children:"When the Mag orientation (alignment) is correct, the 'quad' icon in the Home screen of Configurator should move smoothly and appropriately as the quad is rotated, pitched and rolled. Note that when the quad's attitude is changed very quickly, the heading will initially react quickly on the basis of Gyro and Acc data, and then over the next half second it will be adjusted by the Mag. If the orientation of the Mag data axes is wrong, or the calibration is way off, then these movements will be jerky or completely wrong."})}),"\n",(0,i.jsxs)(t.p,{children:["If the orientation is known to be correct, ie X forward etc, because you can see the orientation markings on the board or have confirmed them by checking the little dot on the sensor, then the default or ",(0,i.jsx)(t.code,{children:"CW0"})," alignment should be correct. Even so, do the checks noted below."]}),"\n",(0,i.jsxs)(t.p,{children:["If you're unsure of the axis orientation, or if you know the Mag is rotated, or upside down, the ",(0,i.jsx)(t.code,{children:"Mag alignment"})," setting in Configurator (",(0,i.jsx)(t.code,{children:"align_mag"})," in CLI) will need to be configured properly:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["if the mag is upright but rotated 90 degrees right, choose ",(0,i.jsx)(t.code,{children:"CW90"}),", etc"]}),"\n",(0,i.jsx)(t.li,{children:"if the mag is inverted, choose one of the 'flip' options."}),"\n",(0,i.jsxs)(t.li,{children:["if the mag is at a custom angle, choose ",(0,i.jsx)(t.code,{children:"CUSTOM"})," orientation, and enter adjustment values in decidegrees in the CLI."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Note that 'flip' functionally rotates the Mag 180 degrees around the Y axis. You pretty much have to experiment with each possible orientation and check each of them until you find one that works. For the HMC5883L/QMC5883L, ",(0,i.jsx)(t.a,{href:"https://intofpv.com/t-betaflight-internals-coordinate-system?pid=55575#pid55575",children:"this post"}),(0,i.jsx)(t.sup,{children:(0,i.jsx)(t.a,{href:"#user-content-fn-11",id:"user-content-fnref-11","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"11"})})," shows a 'cheat sheet' that may help, but only if the chip itself is visible."]}),"\n",(0,i.jsx)(t.h3,{id:"checking-magnetometer-orientation-using-configurators-sensors-tab",children:"Checking Magnetometer Orientation using Configurator's Sensors Tab"}),"\n",(0,i.jsx)(t.p,{children:"The Sensors Tab shows the current X, Y and Z Mag field strength values as detected by the sensor. This information can be used to confirm the correct orientation of the Mag sensor, and to confirm the calibration."}),"\n",(0,i.jsx)(t.admonition,{type:"note",children:(0,i.jsxs)(t.p,{children:["Before checking orientation, the sensor must first be calibrated!",(0,i.jsx)(t.br,{}),"\n","This initial calibration does not have to be perfect, but it must be done."]})}),"\n",(0,i.jsx)(t.p,{children:"When a particular axis is perfectly aligned with the local magnetic field, the other two axes will show zero, or very close to zero. If the value shown is positive, that axis is pointing towards the North of the magnetic field. If negative, it's pointing South."}),"\n",(0,i.jsx)(t.p,{children:"We can use this fact to check the orientation of the Mag after it is attached to the quadcopter. It's best to do this well away from large ferrous metal objects, eg out in an open field or something like that."}),"\n",(0,i.jsx)(t.p,{children:"We need to know the 'north' direction of the Earth's magnetic field, approximately, at our location, so that we can point the nose of the quad kind of directly parallel to that magnetic field line when we go looking at the data returned by our Mag."}),"\n",(0,i.jsx)(t.p,{children:'First, get your phone out, open the Compass settings, and configure it to return Magnetic North (not "true" North). Then open the Compass app, and mark a line on the bench or ground that points to Magnetic North/South.'}),"\n",(0,i.jsx)(t.p,{children:"Then look up your local Inclination value. If you're in the Northern Hemisphere, you'll be pointing the nose of the quad downwards at that angle into the ground, along the North/South magnetic line, when testing the X axis of your sensor. If you're in the Southern Hemisphere, you'll be pointing at that angle up into the sky."}),"\n",(0,i.jsx)(t.p,{children:"Then hook the quad up to Configurator, check the Sensors tab, point the nose of the quad as best possible directly into the magnetic field."}),"\n",(0,i.jsx)(t.p,{children:"If everything is perfect, you should see a large, positive value in the X axis, and smaller, close to zero values in the Y and Z axes. With a bit of adjustment of the angle of the quad, you should be able to get the Y and Z axes really close to zero. If you figure that the nose of the quad looks like it's pointing North, and at the correct angle to the Horizon, and if X is by far the biggest number, then the X axis is aligned correctly!"}),"\n",(0,i.jsx)(t.p,{children:"Then turn the quad 90 degrees right, pointing the 'left side' of the quad, where the Y axis of the sensor should be, directly to Magnetic North. If all is good, the Y axis data will be a big number and X and Z close to zero."}),"\n",(0,i.jsx)(t.p,{children:"Finally, hold the quad so that the top of it is pointing directly into the magnetic field vector. By now you should have a good idea where that is. Z should then have a strongly positive value while X and Y should be close to zero."}),"\n",(0,i.jsx)(t.p,{children:"Complex as this process seems, it is the only way to be 100% sure that the Mag is oriented correctly."}),"\n",(0,i.jsx)(t.p,{children:"If you do not get the expected outcome, a software correction for the orientation of the Magnetometer will be required. Keep trying until it works properly."}),"\n",(0,i.jsx)(t.h3,{id:"software-corrections-for-unusual-magnetometer-orientations",children:"Software Corrections for Unusual Magnetometer Orientations"}),"\n",(0,i.jsx)(t.p,{children:"To get these corrections right, you must know the direction of the magnetic field lines in your test environment. The mag must have been calibrated at some point before fixing the orientation."}),"\n",(0,i.jsx)(t.p,{children:"The goal is to achieve the following result in the Sensors tab, when the specified part of the quad is pointed directly parallel to the field lines:"}),"\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Frame part parallel to field lines"}),(0,i.jsx)(t.th,{children:"X axis"}),(0,i.jsx)(t.th,{children:"Y axis"}),(0,i.jsx)(t.th,{children:"Z axis"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Nose"}),(0,i.jsx)(t.td,{children:"Maximum"}),(0,i.jsx)(t.td,{children:"0"}),(0,i.jsx)(t.td,{children:"0"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Left side"}),(0,i.jsx)(t.td,{children:"0"}),(0,i.jsx)(t.td,{children:"Maximum"}),(0,i.jsx)(t.td,{children:"0"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Top"}),(0,i.jsx)(t.td,{children:"0"}),(0,i.jsx)(t.td,{children:"0"}),(0,i.jsx)(t.td,{children:"Maximum"})]})]})]}),"\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsx)(t.p,{children:"Usually it's best to do initial tests with the mag mounted flat and square to the frame, in the position you'd like it to be. If the mag is in a GPS, and you plan to pitch the GPS back a bit, worry about the tilt later; keep it flat for now."}),"\n",(0,i.jsxs)(t.p,{children:["A good plan is to first check the Z axis. Confirm that it returns a strongly positive number when the top of the quad points directly into to the 'North' of the local field lines. If you get a strongly negative value, the sensor is mounted upside down. You should apply the ",(0,i.jsx)(t.code,{children:"CW0_DEG_FLIP"})," correction at this point, and then move on to check X and Y."]}),"\n",(0,i.jsxs)(t.p,{children:["To check X, move the quad around until you get a positive value on X, and then make smaller adjustments until you see a maximum on X and a zero on Y and Z. Let's say this happens when the right side of the quad is pointing directly parallel to the field lines. That means the X axis is pointing to the right of the quad, i.e. that the sensor is rotated 90 degrees clockwise. The appropriate correction, assuming Z pointed UP, would be ",(0,i.jsx)(t.code,{children:"CW90"}),". If the Z axis pointed down, you'd need ",(0,i.jsx)(t.code,{children:"CW90_FLIP"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"Each time you try a different software orientation, re-test by pointing the nose into to the field lines, looking for a max on X, then check that Y is max when the left side points parallel to the field lines, and finally check that Z is max when the top of the quad points parallel to the field lines. Once you get that, you're done. Unless you intend to tilt the Mag a bit, that is."}),"\n",(0,i.jsx)(t.p,{children:"If the Mag is a separate module, it is definitely easiest if it is mounted flat on the quad, with X forward and Z up, if at all possible."}),"\n",(0,i.jsx)(t.p,{children:"If the Mag is in a GPS, and you want to pitch the GPS backwards at say 30 degrees an additional 30 degree correction will be required, that will also pitch the Mag backwards at 30 degrees."}),"\n",(0,i.jsxs)(t.p,{children:["Unfortunately, this means that the simple, standard ",(0,i.jsx)(t.code,{children:"CW0"})," type corrections cannot be used. You will need to enable custom mag alignment, with ",(0,i.jsx)(t.code,{children:"set align_mag = custom"})," in CLI. Then a value must be entered for each axis that requires correction, using, for example, ",(0,i.jsx)(t.code,{children:"set mag_align_pitch = 300"}),", which compensates for a 30 degree pitch alignment problem."]}),"\n",(0,i.jsx)(t.p,{children:"It's probably best to:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"first determine the standard correction that works when the module is flat to the frame"}),"\n",(0,i.jsx)(t.li,{children:"convert that to a set of custom corrections, in degrees, for each axis"}),"\n",(0,i.jsx)(t.li,{children:"figure out what final change is required to correct for the pitch offset of the module."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Here are some examples:"}),"\n",(0,i.jsxs)(t.p,{children:["If the module requires no correction, i.e. it works perfectly, with X forward and Z up as expected in the CW0 or default orientation while flat, and then if it is pitched backwards 30 degrees, ",(0,i.jsx)(t.code,{children:"set align_mag = custom"})," and ",(0,i.jsx)(t.code,{children:"set mag_align_pitch = 300"})," should fix it."]}),"\n",(0,i.jsxs)(t.p,{children:["If the module requires a ",(0,i.jsx)(t.code,{children:"CW90"})," correction while flat, then the combination of ",(0,i.jsx)(t.code,{children:"set align_mag = custom"}),", ",(0,i.jsx)(t.code,{children:"set mag_align_yaw = 900"})," and ",(0,i.jsx)(t.code,{children:"set mag_align_roll = -300"})," will fix the module being pitched backwards 90 degrees. The correction is required on roll since the sensor is logically rotated 90 degrees."]}),"\n",(0,i.jsxs)(t.p,{children:["A module which requires a ",(0,i.jsx)(t.code,{children:"CW90FLIP"})," correction, and is then pitched back 30 degrees, would require ",(0,i.jsx)(t.code,{children:"set align_mag = custom"}),", ",(0,i.jsx)(t.code,{children:"set mag_align_pitch = 1800"}),", ",(0,i.jsx)(t.code,{children:"set mag_align_yaw = 900"})," and ",(0,i.jsx)(t.code,{children:"set mag_align_roll = 300"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"Note that if the board is rotated 90 degrees, corrections for pitch must be done using roll."}),"\n",(0,i.jsx)(t.h2,{id:"magnetometer-calibration",children:"Magnetometer Calibration"}),"\n",(0,i.jsx)(t.p,{children:"For accurate heading readings, accurate calibration is essential."}),"\n",(0,i.jsx)(t.p,{children:"Calibration 'zeroes out' local magnetic fields arising from nearby ferrous objects on the quad, such as nearby circuit board components, and any inherent offsets in the sensor."}),"\n",(0,i.jsx)(t.p,{children:"The calibration process can be initiated while connected to Configurator, or by using stick commands."}),"\n",(0,i.jsx)(t.admonition,{type:"note",children:(0,i.jsx)(t.p,{children:"In Betaflight 4.5, the frame must be 'tapped' quite hard, within 15s of initiating the calibration process, to start acquiring data. Once the data acquisition phase commences, the LED stops flashing. Data will be acquired over the next 30s and used to calibrate the sensor."})}),"\n",(0,i.jsx)(t.p,{children:"The 'centre' or 'cal' value for an axis is typically a value midway between the min and max values detected for that axis. It is then is subtracted from every reading, centering all readings on that axis around zero. Once the cal value is applied, the reported maximum (most positive) and minimum (most negative) values, for each axis, should be equal in value, but opposite in sign."}),"\n",(0,i.jsxs)(t.p,{children:["Cal values are saved in the ",(0,i.jsx)(t.code,{children:"mag_calibration"})," CLI parameter. For example, ",(0,i.jsx)(t.code,{children:"set mag_calibration = 35,-130,-75"})," will cause the heading code to subtract 35 from every X reading, add 130 to every Y reading, and add 75 ro every Z reading."]}),"\n",(0,i.jsx)(t.p,{children:"For the most accurate calibration results:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"calibrate the quad at, or close to, the intended flight location"}),"\n",(0,i.jsx)(t.li,{children:"while calibrating, keep well away from external metallic or magnetic objects"}),"\n",(0,i.jsx)(t.li,{children:"do several runs, and confirm that the cal values are consistent each time"}),"\n",(0,i.jsx)(t.li,{children:"(expert only) validate that absolute min and max readings are equal on each axis"}),"\n",(0,i.jsx)(t.li,{children:"consider removing the motors"}),"\n"]}),"\n",(0,i.jsx)(t.admonition,{type:"note",children:(0,i.jsx)(t.p,{children:"Magnetic interference from nearby motors can affect calibration very badly. If the motors are turned slowly, and you see twitching of the quad icon on the main Configurator page, significant changes in the Mag heading value, or twitches in the Mag data in the sensors tab, you may have a problem. In flight, these offsets should average out, but during calibration, they will not, and it's likely that you'll bump the motors while twisting it around during the cal process. This can lead to strangely different cal values on repeated testing, no matter how careful you are. The further away the motors are, and the further above or below the plane of the motors, the less of a problem this is. On some quads the only way to get an accurate Mag cal is to remove the motors."})}),"\n",(0,i.jsx)(t.p,{children:"Calibration values, once acquired, typically do not need to be changed much within your local area. They may require updating or checking if you intend to fly a long way from home."}),"\n",(0,i.jsx)(t.admonition,{type:"note",children:(0,i.jsxs)(t.p,{children:["Calibration itself ",(0,i.jsx)(t.strong,{children:"DOES NOT"})," check that the orientation of the sensor is correct!"]})}),"\n",(0,i.jsx)(t.h3,{id:"calibration-initiation",children:"Calibration Initiation"}),"\n",(0,i.jsx)(t.p,{children:"The quad must be disarmed. There are two ways to initiate the calibration process:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["clicking the ",(0,i.jsx)(t.code,{children:"Calibrate Magnetometer"})," button in Configurator, keeping connected with a long USB cable."]}),"\n",(0,i.jsxs)(t.li,{children:["using stick commands on the radio (be absolutely sure that the quad is disarmed!):","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"right stick straight dowm (pitch low with roll centred)"}),"\n",(0,i.jsx)(t.li,{children:"left stick in the top right corner (throttle high and yaw fully right)"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.li,{children:"you then have 15s in which to 'tap the frame' hard, which starts the calibration process itself"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Once the calibration process is activated, the LED on the FC stops flashing."}),"\n",(0,i.jsx)(t.h3,{id:"calibration-technique",children:"Calibration Technique"}),"\n",(0,i.jsx)(t.p,{children:"It's best to record your previous calibration values before re-calibrating, especially if they were OK. This can be done with a Preset>Save command."}),"\n",(0,i.jsx)(t.p,{children:"After initiating a calibration you have 15s to get ready to move the quad around. When you're ready to start moving the frame, tap the arm of the frame quite hard, to make a big spike in the gyro signal. The calibration count-down commences, and the status LED stops flashing. You now have 30s in which to move the quad so that all the magnetometer axes point to all the possible points of the magnetic field."}),"\n",(0,i.jsx)(t.p,{children:"A good way to cover every possible angle is to:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"hold the quad by the battery"}),"\n",(0,i.jsx)(t.li,{children:"swing your arm around in a big circle, eg forwards -> up ->over -> backwards -> downwards, and keep swinging it around like this"}),"\n",(0,i.jsx)(t.li,{children:"yaw the quad, randomly, left and right, at the same time"}),"\n",(0,i.jsx)(t.li,{children:"slowly rotate your whole body about its vertical axis by taking small steps, so that in 30s you have completed a full 360 degree rotation."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"If you know the local field direction, you may start and finish facing North, though this is not necessary."}),"\n",(0,i.jsx)(t.p,{children:"Smoothly completing full rotations about every 1.5-2 seconds works best, but keep in mind that you only have 30s."}),"\n",(0,i.jsxs)(t.p,{children:["Check the ",(0,i.jsx)(t.code,{children:"mag_calibration"})," CLI numbers after each run to see how consistent the values are. If each value is within 50 units of the last couple of runs, that's pretty good. Also check in the Sensors Tab that the Min and Max for each axis are approximately the same number."]}),"\n",(0,i.jsx)(t.admonition,{type:"warning",children:(0,i.jsx)(t.p,{children:"Take great care not to initiate a Mag Cal accidentally! If you 'tap' the frame, but fail to rotate the quad properly after a Cal starts, your old cal values will be lost, and the Mag data will be useless!"})}),"\n",(0,i.jsx)(t.h3,{id:"single-axis-calibration",children:"Single-axis calibration"}),"\n",(0,i.jsx)(t.p,{children:"It's possible to do a 'manual' calibration 'one axis at a time'. This is not the normal or recommended method, but can be used to check the cal value for a particular axis."}),"\n",(0,i.jsx)(t.p,{children:"For example, if we want to get an accurate cal value for the X axis, we can point the nose in the general direction of Magnetic North, and move it randomly around while keeping it generally pointing in the North field vector. Note that both the inclination and declination angles must be considered. This requires knowing the local declination and inclination angles. The idea is to get lots of values that are close to magnetic North, so that at least some are 'spot on'. The nose should be pointed directly North for some 12-13s, then the quad should be reversed 180 degrees, pointing the tail of the quad directly into the field, and moving it around a bit, for the same period of time."}),"\n",(0,i.jsx)(t.p,{children:"If we are connected to the Sensors tab, we should see the X axis being close to maximum, and the other two axes close to zero, when the nose is pointing directly into the field. Conversely, it should show the most negative value when the tail points directly into the field."}),"\n",(0,i.jsxs)(t.p,{children:["The resulting cal value for X can be returned with ",(0,i.jsx)(t.code,{children:"get mag_calibration"})," the CLI; the first value is the X cal value. Record that value. Repeat the process to be sure the X cal value is reliable. Then repeat separately for the Y and Z axes, until you have all three cal values. Then you can type in the cal value for each axis into the CLI in the form ",(0,i.jsx)(t.code,{children:"set mag_calibration = X,Y,Z"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"Normally the method of swinging the arm as it rotates works very well, returning a calibration value for all three axes in one calibration run."}),"\n",(0,i.jsx)(t.h3,{id:"validating-the-heading-using-a-mobile-phone",children:"Validating the Heading using a mobile phone."}),"\n",(0,i.jsx)(t.p,{children:"The heading value can be checked against a mobile phone. Ensure that the mobile phone is set to display true North, not magnetic north, and be sure that your local declination value has been entered into the CLI. Point the quad due North, using your phone to determine North. The heading value on the front page of Configurator, or in the goggles, should read close to 0 / 360 when pointing due North."}),"\n",(0,i.jsx)(t.h3,{id:"fine-tuning-calibration-in-sensors-tab",children:"Fine-tuning Calibration in Sensors Tab."}),"\n",(0,i.jsx)(t.p,{children:"For a well-calibrated Mag, the highest and lowest values, for any individual axis, when the values on the other two axes are close to zero, should be numerically equal."}),"\n",(0,i.jsx)(t.p,{children:"Using the sensors tab to check max and min values for each axis can also validate the accuracy of the existing calibration when flying in a new location. If max and min are very similar, when the other two axes are zero, you don't need to recalibrate."}),"\n",(0,i.jsx)(t.h2,{id:"where-is-heading-information-displayed",children:"Where is heading information displayed?"}),"\n",(0,i.jsx)(t.p,{children:"Heading information is provided to the quad by the GPS unit (course over ground), the IMU (gyro information while turning quickly), and the Mag unit. The IMU code uses 'sensor fusion' methods to integrate the available data to a final 'attitude' or 'heading' value for the quad."}),"\n",(0,i.jsx)(t.p,{children:"The current Heading is shown shown on the main front screen of Configurator, at the top left of the quad icon area. If Mag is enabled, the heading shown reflects Mag data, and will return a value indicating the angle of the nose of the quad relative to North. Without a mag, the heading value always starts at 0 or 359 degrees, and only changes because integral of the gyro data can be used to indicate a relative change in yaw since arming."}),"\n",(0,i.jsx)(t.p,{children:"If the code is built with GPS support, both the current Mag heading and the GPS course over ground heading are shown in Configurator's GPS tab."}),"\n",(0,i.jsx)(t.p,{children:"In the OSD, heading can be shown as numerical values in degrees, or indicated graphically."}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsx)(t.p,{children:"If everything is working properly, the quad's icon, as shown in the main page of Configurator, should move without sudden jumps, once Mag is enabled. Sudden jumps after quick movements usually mean that the orientation is not correct."})}),"\n",(0,i.jsxs)(t.p,{children:["If GPS working properly, and GPS Rescue enabled in the Failsafe tab, heading information from Mag can be logged in Debug 4 of the ",(0,i.jsx)(t.code,{children:"GPS_RESCUE_HEADING"})," debug."]}),"\n",(0,i.jsx)(t.p,{children:"MagADC X, Y and Z values are always logged to Blackbox, and should be examined after an initial flight to ensure they are not really noisy. The noise should be much less than the signal. If noise is obviously an issue, mount the mag further away from the motors, and away from high-current wires, ensuring that the sensor is equidistant from pairs of motors, and check that there is adequate filtering on the power supply to the Mag module."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsxs)(t.em,{children:["Drafted by ",(0,i.jsx)(t.strong,{children:"ctzsnooze"})," in 2023-09 for Betaflight 4.5. Huge shout out to ",(0,i.jsx)(t.strong,{children:"ledvinap"})," and ",(0,i.jsx)(t.strong,{children:"pichim"})," for their help and guidance."]})}),"\n",(0,i.jsx)(t.h2,{id:"external-links",children:"External Links"}),"\n",(0,i.jsxs)(t.section,{"data-footnotes":!0,className:"footnotes",children:[(0,i.jsx)(t.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{id:"user-content-fn-1",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Earth%27s_magnetic_field",children:"Earth's Magnetic Field - Wikipedia"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-1","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"\u21a9"})," ",(0,i.jsxs)(t.a,{href:"#user-content-fnref-1-2","data-footnote-backref":"","aria-label":"Back to reference 1-2",className:"data-footnote-backref",children:["\u21a9",(0,i.jsx)(t.sup,{children:"2"})]})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-2",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://physicsmax.com/inclination-dip-7371",children:"Inclination or Dip - PhysicsMax"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-2","data-footnote-backref":"","aria-label":"Back to reference 2",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-3",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.ngdc.noaa.gov/geomag/calculators/magcalc.shtml",children:"Magnetic Field Calculators - NOAA"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-3","data-footnote-backref":"","aria-label":"Back to reference 3",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-4",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.magnetic-declination.com",children:"Inclination and Declination map"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-4","data-footnote-backref":"","aria-label":"Back to reference 4",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-8",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://datasheet.lcsc.com/szlcsc/QST-QMC5883L-TR_C192585.pdf",children:"QMC5883L datasheet"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-8","data-footnote-backref":"","aria-label":"Back to reference 5",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-9",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://intofpv.com/attachment.php?aid=8104",children:"IST8310 datasheet"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-9","data-footnote-backref":"","aria-label":"Back to reference 6",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-10",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.st.com/resource/en/datasheet/lis3mdl.pdf",children:"LIS3MDL datasheet"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-10","data-footnote-backref":"","aria-label":"Back to reference 7",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-7",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://cdn-shop.adafruit.com/datasheets/HMC5883L_3-Axis_Digital_Compass_IC.pdf",children:"HMC5883L datasheet"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-7","data-footnote-backref":"","aria-label":"Back to reference 8",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-5",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.alldatasheet.com/datasheet-pdf/pdf/535561/AKM/AK8963.html",children:"AK8963 datasheet (disccontinued)"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-5","data-footnote-backref":"","aria-label":"Back to reference 9",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-6",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.alldatasheet.com/datasheet-pdf/pdf/535562/AKM/AK8975.html",children:"AK8975 datasheet (discontinued)"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-6","data-footnote-backref":"","aria-label":"Back to reference 10",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{id:"user-content-fn-11",children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://intofpv.com/t-betaflight-internals-coordinate-system?pid=55575#pid55575",children:"HMC5883L/QMC5883L cheat sheet"})," ",(0,i.jsx)(t.a,{href:"#user-content-fnref-11","data-footnote-backref":"","aria-label":"Back to reference 11",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n"]}),"\n"]})]})}function u(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},11151:(e,t,n)=>{n.d(t,{Z:()=>s,a:()=>r});var i=n(67294);const a={},o=i.createContext(a);function r(e){const t=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(o.Provider,{value:t},e.children)}}}]);